<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Coordinator Panel | Attendance Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<style>
body {
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(135deg, #6aaaff, #7fd1ae);
    margin: 0;
    padding: 0;
}
.container {
    padding: 15px;
    max-width: 700px;
    margin: auto;
}
h2 {
    text-align: center;
    color: #ffffff;
    margin: 15px 0 20px 0;
    text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
}
#scanner {
    width: 100%;
    height: 250px;
    border: 3px solid #ffffff;
    border-radius: 12px;
    background: #f1f1f1;
    overflow: hidden;
    margin-bottom: 15px;
}
#scanner video {
    width: 100% !important;
    height: auto !important;
    object-fit: contain !important;
}
#output {
    text-align: center;
    font-weight: bold;
    color: #28a745;
    margin-bottom: 10px;
}
#manualForm input {
    font-size: 14px;
}
#manualResult {
    font-weight: bold;
    margin-top: 5px;
}
#netStatus {
    text-align: center;
    font-weight: bold;
    margin-bottom: 5px;
    color: #ffffff;
}
#pendingCount {
    text-align: center;
    background-color: rgb(214, 156, 11);
    font-weight: bold;
    color: rgb(20, 20, 255);
    margin-bottom: 10px;
}
button, select, input[type="file"] {
    font-size: 14px;
    padding: 6px 10px;
    border-radius: 6px;
}
.btn-success { background: #28a745; color: white; }
.btn-success:hover { background: #218838; }
.btn-primary { background: #007bff; color: white; }
.btn-primary:hover { background: #0056b3; }
.hidden { display: none; }
#presentCount {
    text-align: center;
    background-color: rgb(214, 156, 11);
    font-weight: bold;
    color: rgb(20, 20, 255);
    margin-bottom: 10px;
}
</style>
</head>
<body>

<div class="container">
  <h2>ðŸ“‹ Attendance Panel</h2>
  <div id="netStatus">ðŸŸ¢ Online</div>
  <div id="presentCount">Present: 0</div>
  <div id="pendingCount"></div>

  <!-- Sheet selection -->
  <div class="mb-2">
    <select id="sheetDropdown" class="form-select">
      <option value="" disabled selected>Select Session Sheet</option>
    </select>
  </div>

  <!-- Camera selection -->
  <div class="mb-2" id="cameraBlock">
    <label for="cameraSelect" class="form-label text-white">Select Camera:</label>
    <select id="cameraSelect" class="form-select"></select>
  </div>

  <!-- Scanner -->
  <div id="scanner"></div>
  <div id="output"></div>

  <!-- Buttons -->
  <div class="d-flex justify-content-between mb-2">
    <button class="btn btn-success btn-sm flex-fill me-1" onclick="toggleManualForm()">Manual Attendance</button>
    <button class="btn btn-primary btn-sm flex-fill ms-1" onclick="downloadLocalAttendance()">Download Marked Students</button>
  </div>

  <!-- Manual form -->
  <div id="manualForm" class="hidden mb-2">
    <input type="text" id="manualEnroll" class="form-control mb-1" placeholder="Enter Enrollment No">
    <button class="btn btn-success btn-sm w-100" onclick="submitManual()">Submit</button>
    <div id="manualResult"></div>
  </div>

  <audio id="successSound" src="https://www.soundjay.com/buttons/sounds/button-3.mp3" preload="auto"></audio>
</div>

<script>
let sheetName = "",
    coordinator = localStorage.getItem("coordinator"),
    lastScanned = "",
    pendingQueue = [],
    allEnrollments = {},
    localMarked = JSON.parse(localStorage.getItem("localMarked")) || [];

const scriptURL = "https://script.google.com/macros/s/AKfycbwkpA1BWvUNZhnJHYUB5s87RjiFJP7tzRp2OL-O1DceBpxLP1digI_ieJxwp3I8yj5c/exec";

// unauthorized check
if (!coordinator) {
  alert("Unauthorized access. Please login first.");
  window.location.href = "login.html";
}

// present count updater
function updatePresentCount() {
  if (!sheetName) return;
  fetch(`${scriptURL}?action=getPresentCount&Sheet=${encodeURIComponent(sheetName)}`)
    .then(res => res.json())
    .then(data => { document.getElementById("presentCount").textContent = `Present: ${data.count}`; });
}
setInterval(updatePresentCount, 1000);

// online/offline status
function updateStatus(online) {
  document.getElementById("netStatus").textContent = online ? "ðŸŸ¢ Online" : "ðŸ”´ Offline";
  updatePendingCount();
}
window.addEventListener('online', () => updateStatus(true));
window.addEventListener('offline', () => updateStatus(false));

window.onload = function() {
  // load sheets
  fetch(`${scriptURL}?action=getSheets`)
    .then(res => res.json())
    .then(data => {
      const dropdown = document.getElementById("sheetDropdown");
      data.sheets.forEach(sheet => {
        const opt = document.createElement("option");
        opt.value = sheet;
        opt.textContent = sheet;
        dropdown.appendChild(opt);
      });
    });

  const saved = localStorage.getItem("pendingAttendance");
  if (saved) pendingQueue = JSON.parse(saved);
  updatePendingCount();

  // detect cameras
  navigator.mediaDevices.enumerateDevices().then(devices => {
    const videoDevices = devices.filter(d => d.kind === "videoinput");
    const select = document.getElementById("cameraSelect");
    const cameraBlock = document.getElementById("cameraBlock");

    if (videoDevices.length <= 1) {
      cameraBlock.style.display = "none";
      startScannerWithDevice(null); // auto start
    } else {
      videoDevices.forEach(d => {
        const opt = document.createElement("option");
        opt.value = d.deviceId;
        opt.textContent = d.label || `Camera ${select.length+1}`;
        select.appendChild(opt);
      });
      startScannerWithDevice(videoDevices[0].deviceId);
    }
  });
};

// sheet selection
document.getElementById("sheetDropdown").addEventListener("change", e => {
  sheetName = e.target.value;
  loadAllEnrollments(sheetName);
});

// camera selection
document.getElementById("cameraSelect").addEventListener("change", e => {
  startScannerWithDevice(e.target.value);
});

// load enrollments
function loadAllEnrollments(sheet) {
  fetch(`${scriptURL}?action=getAllEnrollments&Sheet=${encodeURIComponent(sheet)}`)
    .then(res => res.json())
    .then(data => {
      allEnrollments = {};
      data.enrollments.forEach(item => {
        // build full name from FirstName + MiddleName + LastName
        const fullName = `${item.FirstName || ""} ${item.MiddleName || ""} ${item.LastName || ""}`.trim();
        allEnrollments[item.EnrollmentNo.trim()] = {
          row: item.row,
          name: fullName
        };
      });
    });
}

// start scanner
function startScannerWithDevice(deviceId) {
  if (!sheetName) return;
  if (Quagga.initialized) { Quagga.stop(); Quagga.initialized = false; }

  let constraints = {};
  if (deviceId) constraints.deviceId = { exact: deviceId };
  else constraints.facingMode = { ideal: "environment" };

  Quagga.init({
    inputStream: {
      name: "Live",
      type: "LiveStream",
      target: document.querySelector('#scanner'),
      constraints: constraints
    },
    locator: { patchSize: "medium", halfSample: false },
    decoder: { readers: ["code_128_reader"] },
    locate: true
  }, function(err) {
    if (err) {
      console.error("Quagga init error:", err);
      // fallback to front camera
      if (!deviceId) {
        Quagga.init({
          inputStream: {
            name: "Live",
            type: "LiveStream",
            target: document.querySelector('#scanner'),
            constraints: { facingMode: "user" }
          },
          decoder: { readers: ["code_128_reader"] },
          locate: true
        }, function(err2) {
          if (err2) { console.error("Second init error:", err2); return; }
          Quagga.initialized = true;
          Quagga.start();
          Quagga.onDetected(onDetected);
        });
      }
      return;
    }
    Quagga.initialized = true;
    Quagga.start();
    Quagga.onDetected(onDetected);
  });
}

// barcode detection
function onDetected(result) {
  const code = result.codeResult.code;
  if (code === lastScanned) return;
  lastScanned = code;
  markPresent(code, "Scanner");
  setTimeout(() => lastScanned = "", 400);
}

// manual form
function toggleManualForm() {
  document.getElementById("manualForm").classList.toggle("hidden");
  document.getElementById("manualResult").textContent = "";
  document.getElementById("manualEnroll").value = "";
}
function submitManual() {
  const enr = document.getElementById("manualEnroll").value.trim();
  markPresent(enr, "Manual");
}

// mark present
function markPresent(enrollment, method) {
  const out = document.getElementById("output");
  const resultEl = document.getElementById("manualResult");

  if (!(enrollment in allEnrollments)) {
    out.innerHTML = `âŒ ${enrollment} not found`;
    if(resultEl){ resultEl.textContent=""; resultEl.style.color="red"; }
    return;
  }

  if (!localMarked.includes(enrollment)) {
    localMarked.push(enrollment);
    localStorage.setItem("localMarked", JSON.stringify(localMarked));
  }

  const studentName = allEnrollments[enrollment]?.name || "";
  const data = { EnrollmentNo: enrollment, Name: studentName, Method: method, Coordinator: coordinator, Timestamp: new Date().toLocaleString(), Sheet: sheetName };

  pendingQueue.push(data);
  localStorage.setItem("pendingAttendance", JSON.stringify(pendingQueue));
  updatePendingCount();

  out.innerHTML = `âœ” ${enrollment} - ${studentName} marked Present (${method})`;
  if(resultEl){ resultEl.textContent = `âœ” ${enrollment} - ${studentName} marked Present`; resultEl.style.color="green"; }
  document.getElementById("successSound").play();
  updatePresentCount();
}

// pending count
function updatePendingCount() {
  document.getElementById("pendingCount").textContent = `Pending to sync: ${pendingQueue.length}`;
}

// sync loop
setInterval(() => {
  if (navigator.onLine && pendingQueue.length>0) {
    const batch = pendingQueue.splice(0,10);
    const promises = batch.map(data => fetch(`${scriptURL}?action=markPresent`, { method:"POST", body:buildFormData(data) }).then(res=>res.json()));
    Promise.all(promises).then(results => {
      pendingQueue = pendingQueue.concat(batch.filter((_,i)=>results[i].status!=="success"));
      localStorage.setItem("pendingAttendance", JSON.stringify(pendingQueue));
      updatePendingCount();
    }).catch(()=>{ pendingQueue = batch.concat(pendingQueue); localStorage.setItem("pendingAttendance", JSON.stringify(pendingQueue)); });
  }
}, 2000);

// build form data
function buildFormData(obj) {
  const fd = new FormData();
  Object.entries(obj).forEach(([k,v])=>fd.append(k,v));
  return fd;
}

// download marked students
function downloadLocalAttendance() {
  if(localMarked.length === 0) return alert("No marked students to download.");
  const blob = new Blob([localMarked.join("\n")], {type: "text/plain"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `Marked_Students_${new Date().toISOString().slice(0,10)}.txt`;
  a.click();
  URL.revokeObjectURL(url);
}

window.addEventListener("beforeunload", function(e){
  e.preventDefault();
  e.returnValue = "Are you sure you want to leave? Attendance data might be lost.";
});
</script>

</body>
</html>

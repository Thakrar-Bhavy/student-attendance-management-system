<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Student Attendance</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f7f9;
      margin: 0; padding: 0;
    }
    header {
      background: #009688;
      color: white;
      text-align: center;
      padding: 15px;
      font-size: 22px;
    }
    .container {
      max-width: 400px;
      margin: 40px auto;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      text-align: center;
    }
    input, button {
      padding: 12px;
      margin: 8px 0;
      width: 100%;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    button {
      background: #009688;
      color: white;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover { background: #00695c; }
    .message { margin-top: 12px; font-weight: bold; }
    .success { color: green; }
    .error { color: red; }
    .warning { color: orange; }
    .student-info {
      text-align: left;
      margin: 15px 0;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 8px;
      border-left: 4px solid #009688;
    }
    .offline-notice {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #ff9800;
      color: white;
      padding: 10px;
      text-align: center;
      display: none;
    }
  </style>
</head>
<body>

<header>Student Attendance</header>

<div class="container">
  <h3>Mark Your Attendance</h3>
  <input type="text" id="sessionId" placeholder="Enter Session ID">
  <input type="password" id="pin" placeholder="Enter Session PIN">
  <input type="text" id="enrollment" placeholder="Enter Enrollment No">
  <button onclick="markAttendance()">Mark Present</button>
  <div id="message" class="message"></div>
  
  <div id="studentInfo" class="student-info" style="display: none;">
    <h4>Student Information</h4>
    <div id="studentDetails"></div>
  </div>
</div>

<div id="offlineNotice" class="offline-notice">
  ‚ö†Ô∏è No internet connection. Your attendance will be submitted when you're back online.
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx_g8dpWKldk8TUxeUzj2kJeF8NVHLjE89dnametJrCBsLnzdBA7PmsHxKJnZH-vEak/exec";

// Create a random device token (simulate unique phone)
if(!localStorage.getItem("deviceToken")){
  localStorage.setItem("deviceToken","dev_"+Math.random().toString(36).substr(2,9));
}
const deviceToken = localStorage.getItem("deviceToken");

// Check if device is banned for any session
if (localStorage.getItem("banned")) {
  document.getElementById("message").innerText = "üö´ Your device is blocked from marking attendance.";
  document.getElementById("message").className = "message error";
  document.querySelector("button").disabled = true;
}

// Check online/offline status
window.addEventListener('online', function() {
  document.getElementById('offlineNotice').style.display = 'none';
  // Try to submit any pending attendance
  submitPendingAttendance();
});

window.addEventListener('offline', function() {
  document.getElementById('offlineNotice').style.display = 'block';
});

// Try to get location
function getLocation(callback){
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(
      pos => callback({lat:pos.coords.latitude, lng:pos.coords.longitude}),
      error => {
        console.error("Geolocation error:", error);
        callback(null);
      },
      { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
    );
  } else callback(null);
}

// Verify student before marking attendance
async function verifyStudent(sessionId, enrollment, pin) {
  try {
    const res = await fetch(SCRIPT_URL, {
      method: "POST",
      body: JSON.stringify({
        action: "verifyStudent",
        sessionId,
        enrollment,
        pin
      })
    });
    return await res.json();
  } catch (error) {
    console.error("Verification error:", error);
    return { error: "Network error during verification" };
  }
}

// Mark attendance
async function markAttendance(){
  const sessionId = document.getElementById("sessionId").value.trim();
  const pin = document.getElementById("pin").value.trim();
  const enrollment = document.getElementById("enrollment").value.trim();
  const msg = document.getElementById("message");

  if(!sessionId || !enrollment || !pin){
    msg.innerText = "Fill all fields";
    msg.className = "message error";
    return;
  }

  // First verify student
  const verification = await verifyStudent(sessionId, enrollment, pin);
  if (verification.error) {
    msg.innerText = "‚ùå " + verification.error;
    msg.className = "message error";
    return;
  }

  if (verification.student) {
    // Show student information for confirmation
    document.getElementById("studentInfo").style.display = "block";
    document.getElementById("studentDetails").innerHTML = `
      <p><strong>Name:</strong> ${verification.student.FirstName} ${verification.student.MidalName} ${verification.student.LastName}</p>
      <p><strong>Mobile:</strong> ${verification.student.Mobile}</p>
      <p><strong>Department:</strong> ${verification.student.Department}</p>
    `;
    
    // Ask for confirmation
    if (!confirm(`Is this your information? \nName: ${verification.student.FirstName} ${verification.student.MidalName} ${verification.student.LastName}\nMobile: ${verification.student.Mobile}\n\nClick OK to confirm attendance.`)) {
      return;
    }
  }

  // Check if we're offline
  if (!navigator.onLine) {
    // Store attendance for later submission
    const pendingAttendance = JSON.parse(localStorage.getItem("pendingAttendance") || "[]");
    pendingAttendance.push({
      sessionId, enrollment, pin, deviceToken, timestamp: new Date().toISOString()
    });
    localStorage.setItem("pendingAttendance", JSON.stringify(pendingAttendance));
    
    msg.innerText = "‚ö†Ô∏è No internet connection. Your attendance is queued and will be submitted when online.";
    msg.className = "message warning";
    return;
  }

  // We're online, proceed with attendance marking
  getLocation(async (coords) => {
    try {
      const res = await fetch(SCRIPT_URL, {
        method: "POST",
        body: JSON.stringify({
          action: "markAttendance", 
          sessionId, 
          enrollment, 
          pin, 
          deviceToken, 
          coords
        })
      });
      const data = await res.json();

      if(data.status === "success"){
        msg.innerText = "‚úÖ You are marked Present";
        msg.className = "message success";
        
        // Clear form after successful submission
        document.getElementById("sessionId").value = "";
        document.getElementById("pin").value = "";
        document.getElementById("enrollment").value = "";
        document.getElementById("studentInfo").style.display = "none";
      } else if(data.status === "closed"){
        msg.innerText = "‚ùå Session closed. Meet coordinator.";
        msg.className = "message error";
      } else if(data.status === "already_marked"){
        msg.innerText = "‚ö†Ô∏è Already marked present";
        msg.className = "message warning";
      } else if(data.status === "outside"){
        msg.innerText = "‚ùå You are not in allowed location";
        msg.className = "message error";
      } else if(data.status === "banned"){
        msg.innerText = "üö´ Device blocked for multiple attempts";
        msg.className = "message error";
        localStorage.setItem("banned", "true");
        document.querySelector("button").disabled = true;
      } else {
        msg.innerText = "‚ùå " + data.message;
        msg.className = "message error";
      }
    } catch (error) {
      console.error("Attendance error:", error);
      // Store for offline submission
      const pendingAttendance = JSON.parse(localStorage.getItem("pendingAttendance") || "[]");
      pendingAttendance.push({
        sessionId, enrollment, pin, deviceToken, timestamp: new Date().toISOString()
      });
      localStorage.setItem("pendingAttendance", JSON.stringify(pendingAttendance));
      
      msg.innerText = "‚ö†Ô∏è Network error. Your attendance is queued and will be submitted when online.";
      msg.className = "message warning";
    }
  });
}

// Submit pending attendance when back online
async function submitPendingAttendance() {
  const pendingAttendance = JSON.parse(localStorage.getItem("pendingAttendance") || "[]");
  if (pendingAttendance.length === 0) return;

  const msg = document.getElementById("message");
  msg.innerText = "üîÑ Submitting queued attendance...";
  msg.className = "message";

  for (let i = 0; i < pendingAttendance.length; i++) {
    const attendance = pendingAttendance[i];
    try {
      getLocation(async (coords) => {
        const res = await fetch(SCRIPT_URL, {
          method: "POST",
          body: JSON.stringify({
            action: "markAttendance", 
            sessionId: attendance.sessionId, 
            enrollment: attendance.enrollment, 
            pin: attendance.pin, 
            deviceToken: attendance.deviceToken, 
            coords
          })
        });
        const data = await res.json();
        
        if (data.status === "success") {
          // Remove successfully submitted attendance
          pendingAttendance.splice(i, 1);
          localStorage.setItem("pendingAttendance", JSON.stringify(pendingAttendance));
          i--; // Adjust index after removal
        }
      });
    } catch (error) {
      console.error("Error submitting queued attendance:", error);
    }
  }

  if (pendingAttendance.length === 0) {
    msg.innerText = "‚úÖ All queued attendance submitted successfully";
    msg.className = "message success";
  } else {
    msg.innerText = `‚ö†Ô∏è Submitted some attendance. ${pendingAttendance.length} items still queued.`;
    msg.className = "message warning";
  }
}

// Block access on laptops/desktops
if (!/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
  document.body.innerHTML = `
    <header>Student Attendance</header>
    <div class="container">
      <h3>Mobile Access Required</h3>
      <p>‚ùå This attendance system is only accessible on mobile devices.</p>
      <p>Please use your smartphone to mark attendance.</p>
    </div>
  `;
}

// Check for any pending attendance on load
window.addEventListener('load', function() {
  const pendingAttendance = JSON.parse(localStorage.getItem("pendingAttendance") || "[]");
  if (pendingAttendance.length > 0 && navigator.onLine) {
    submitPendingAttendance();
  }
});
</script>

</body>
</html>

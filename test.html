<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Student Attendance</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f7fa;
      color: #333;
    }
    header {
      background: #006699;
      color: white;
      padding: 15px;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
    }
    .container {
      max-width: 480px;
      margin: 20px auto;
      padding: 20px;
      background: white;
      border-radius: 14px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    h2 {
      color: #006699;
      text-align: center;
      margin-bottom: 20px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    input, button {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    button {
      background: #006699;
      color: white;
      font-weight: bold;
      cursor: pointer;
      border: none;
    }
    button:hover {
      background: #004466;
    }
    .message {
      margin-top: 10px;
      font-weight: bold;
      text-align: center;
    }
    .success { color: #28a745; }
    .error { color: #dc3545; }
    .warning { color: #ff9800; }
    .student-info {
      margin: 15px 0;
      padding: 12px;
      background: #eef9ff;
      border-left: 4px solid #006699;
      border-radius: 8px;
    }
    @media(min-width: 600px) {
      body::before {
        content: "⚠️ Please use a mobile device.";
        display: block;
        text-align: center;
        margin-top: 50px;
        font-size: 18px;
        color: red;
      }
      .container { display: none; }
    }
  </style>
</head>
<body>
<header>Student Attendance</header>
<div class="container">
  <h2>Mark Your Attendance</h2>
  <div class="form-group">
    <input type="text" id="sessionId" placeholder="Session ID">
  </div>
  <div class="form-group">
    <input type="password" id="sessionPin" placeholder="Session PIN">
  </div>
  <div class="form-group">
    <input type="text" id="enrollment" placeholder="Enrollment Number">
  </div>
  <button onclick="verifyStudent()">Verify</button>

  <div id="studentInfo" class="student-info" style="display:none;"></div>
  <button id="markBtn" style="display:none;" onclick="markAttendance()">✅ Mark Present</button>

  <div id="statusMsg" class="message"></div>
</div>

<script>
const SCRIPT_URL = "YOUR_APPS_SCRIPT_EXEC_URL"; // Replace with your deployed Apps Script exec URL

// Device token (unique per phone)
let deviceToken = localStorage.getItem("deviceToken");
if(!deviceToken){
  deviceToken = "dev_" + Math.random().toString(36).substr(2,9) + "_" + Date.now();
  localStorage.setItem("deviceToken", deviceToken);
}

async function verifyStudent(){
  const sessionId = document.getElementById("sessionId").value.trim();
  const pin = document.getElementById("sessionPin").value.trim();
  const enrollment = document.getElementById("enrollment").value.trim();
  if(!sessionId || !pin || !enrollment){
    showMsg("Please fill all fields","error");
    return;
  }

  showMsg("Verifying...","warning");
  try {
    const res = await fetch(`${SCRIPT_URL}?action=exportSession&sessionId=${sessionId}`);
    const csv = await res.text();
    const rows = csv.split("\n").map(r=>r.split(","));
    let found=null;
    for(let i=1;i<rows.length;i++){
      if(rows[i][0].replace(/"/g,"")===enrollment){
        found = {enrollment: rows[i][0], name: rows[i][1]+" "+rows[i][3], mobile: rows[i][4]};
        break;
      }
    }
    if(!found){
      showMsg("Enrollment not found","error");
      return;
    }
    document.getElementById("studentInfo").innerText = `Enrollment: ${found.enrollment}\nName: ${found.name}\nMobile: ${found.mobile}`;
    document.getElementById("studentInfo").style.display="block";
    document.getElementById("markBtn").style.display="block";
    showMsg("Verified! Please mark your attendance.","success");
  } catch(err){
    showMsg("Error verifying: "+err,"error");
  }
}

async function markAttendance(){
  const sessionId = document.getElementById("sessionId").value.trim();
  const pin = document.getElementById("sessionPin").value.trim();
  const enrollment = document.getElementById("enrollment").value.trim();

  showMsg("Marking attendance...","warning");

  // Capture location
  navigator.geolocation.getCurrentPosition(async (pos)=>{
    const coords = {lat: pos.coords.latitude, lng: pos.coords.longitude};
    try {
      const res = await fetch(SCRIPT_URL,{
        method:"POST",
        body: JSON.stringify({
          action:"markAttendance",
          sessionId, pin, enrollment, deviceToken, coords
        })
      });
      const data = await res.json();
      if(data.status==="success"){
        showMsg("✅ Attendance marked successfully!","success");
        document.getElementById("markBtn").disabled=true;
      } else if(data.status==="closed"){
        showMsg("Session closed, meet coordinator.","error");
      } else if(data.status==="banned"){
        showMsg("⚠️ Device banned due to proxy attempts.","error");
      } else if(data.status==="already_marked"){
        showMsg("Attendance already marked.","warning");
      } else if(data.status==="outside"){
        showMsg("You are outside allowed location.","error");
      } else {
        showMsg(data.message,"error");
      }
    } catch(err){
      queueOffline(sessionId,pin,enrollment,coords);
    }
  },()=>showMsg("Location required to mark attendance.","error"));
}

// Offline queue handling
function queueOffline(sessionId,pin,enrollment,coords){
  let queue = JSON.parse(localStorage.getItem("offlineQueue")||"[]");
  queue.push({sessionId,pin,enrollment,deviceToken,coords,retries:0});
  localStorage.setItem("offlineQueue",JSON.stringify(queue));
  showMsg("Internet slow, trying...","warning");
  retryQueue();
}

async function retryQueue(){
  let queue = JSON.parse(localStorage.getItem("offlineQueue")||"[]");
  if(queue.length===0) return;
  let newQueue=[];
  for(const item of queue){
    try{
      const res = await fetch(SCRIPT_URL,{
        method:"POST",
        body: JSON.stringify({...item, action:"markAttendance"})
      });
      const data = await res.json();
      if(data.status!=="success"){
        item.retries++;
        if(item.retries<3) newQueue.push(item);
      }
    }catch(err){
      item.retries++;
      if(item.retries<3) newQueue.push(item);
    }
  }
  localStorage.setItem("offlineQueue",JSON.stringify(newQueue));
  if(newQueue.length>0) setTimeout(retryQueue,5000);
}

function showMsg(msg,type){
  const el=document.getElementById("statusMsg");
  el.innerText=msg;
  el.className="message "+type;
}
</script>
</body>
</html>
